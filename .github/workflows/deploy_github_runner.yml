name: 'Deploy github_runner'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to execute the code against'
        type: environment
        required: true

permissions:
  contents: read

jobs:
  terraform-plan:
    name: 'Terraform plan'
    runs-on: [self-hosted, Linux, Proxmox]
    defaults:
      run:
        working-directory: github_runner/environments/${{ inputs.environment }}/terraform
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode GCP credentials and set env
        run: |
          {
            echo "GOOGLE_APPLICATION_CREDENTIALS<<EOF"
            echo '${{ secrets.GCP_TF_STORAGE_SA_KEY }}' | base64 --decode
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Save Plan Artifact
        uses: actions/upload-artifact@v3
        with:
          name: tfplan
          path: github_runner/environments/${{ inputs.environment }}/terraform
  
  approve-changes:
    name: 'Approve Terraform plan'
    runs-on: [self-hosted, Linux, Proxmox]
    needs: terraform-plan
    environment: review
    steps:
      - name: Accept changes
        run: echo "Changes has been accepted.."

  terraform-apply:
      name: 'Apply Terraform changes'
      runs-on: [self-hosted, Linux, Proxmox]
      needs: approve-changes
      env: 
        TF_VAR_proxmox_api_token_secret: ${{ secrets.PROXMOX_TF_API_KEY }}
      defaults:
        run:
          working-directory: github_runner/environments/${{ inputs.environment }}/terraform
          shell: bash
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Decode GCP credentials and set env
          run: |
            {
              echo "GOOGLE_APPLICATION_CREDENTIALS<<EOF"
              echo '${{ secrets.GCP_TF_STORAGE_SA_KEY }}' | base64 --decode
              echo "EOF"
            } >> $GITHUB_ENV

        - name: Download Plan Artifact
          uses: actions/download-artifact@v3
          with:
            name: tfplan
            path: github_runner/environments/${{ inputs.environment }}/terraform
        
        - name: Terraform apply
          run: terraform apply -auto-approve -input=false tfplan